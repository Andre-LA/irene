require 'math'
require 'nene'
require 'rotor-quick.core'
require 'rotor-quick.makers'
require 'rotor-quick.components.intersections'
require 'rotor-quick.components.painter'

local RQ_Comps = RotorQuick.Components

global RotorQuick.Systems.IntersectionsPainter = @MakeSystem('IntersectionsPainter', @record{
  intersections: RQ_Comps.Intersections,
})

local IntersectionsPainter = RotorQuick.Systems.IntersectionsPainter

function IntersectionsPainter:run(core_state: *Nene.CoreState)
  ## if PROF then
    nprof:push(#[IntersectionsPainter.value.nickname]#)
    defer nprof:pop() end
  ## end

  for _, components in self:iterate_components() do
    local intersections = components.intersections

    for i = 0, < #intersections.intersections do
      local intersection = intersections.intersections[i]
      local rect_color: Nene.Color = intersection.cycles_live > 0 and Nene.Palette.red or Nene.Palette.green
      core_state:render_draw_rect(intersection.rect:to_rect(), true, rect_color)
    end
  end
end

